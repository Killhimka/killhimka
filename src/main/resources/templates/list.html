<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Employee List</title>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script> <!-- Подключаем Axios -->
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f4f4f4; }
        .container { background-color: #fff; padding: 30px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        h1 { color: #333; margin-bottom: 20px; }
        .actions { margin-bottom: 20px; display: flex; gap: 10px; } /* Небольшое изменение для лучшего расположения */
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
        .action-button {
            display: inline-block;
            padding: 8px 12px; /* Немного уменьшил padding, чтобы выглядело более компактно */
            border: none;
            border-radius: 4px;
            cursor: pointer;
            text-decoration: none;
            font-size: 13px;
            transition: background-color 0.3s;
            margin-right: 5px; /* Уменьшил отступ */
        }
        .action-button.primary { background-color: #007bff; color: white; }
        .action-button.primary:hover { background-color: #0056b3; }
        .action-button.secondary { background-color: #6c757d; color: white; }
        .action-button.secondary:hover { background-color: #545b62; }
        .action-button.delete { background-color: #dc3545; color: white; }
        .action-button.delete:hover { background-color: #c82333; }
        .back-button { background-color: #6c757d; } /* Оставил стиль, но можно тоже сделать .secondary */
        .back-button:hover { background-color: #545b62; }

        /* Стиль для сообщений */
        .message { margin-top: 15px; padding: 10px; border-radius: 4px; text-align: center; }
        .success { color: #155724; background-color: #d4edda; border: 1px solid #c3e6cb; }
        .error { color: #721c24; background-color: #f8d7da; border: 1px solid #f5c6cb; }

        /* Стиль для заглушки "Loading..." */
        .loading-message td { text-align: center; font-style: italic; color: #666; }
    </style>
</head>
<body>
<div class="container">
    <h1>Employee List</h1>

    <div class="actions">
        <a href="/employees/add-form" class="action-button primary">Add New Employee</a>
        <a href="/dashboard" class="action-button secondary">Back to Dashboard</a>
    </div>

    <!-- Место для отображения сообщений -->
    <div id="responseMessage" class="message hidden"></div> <!-- Изначально скрыт -->

    <table>
        <thead>
        <tr>
            <th>ID</th>
            <th>Full Name</th>
            <th>Age</th>
            <th>Address</th>
            <th>Position</th>
            <th>Actions</th>
        </tr>
        </thead>
        <tbody>
        <!-- Здесь будет динамически отрисовываться таблица -->
        <!-- Начальное состояние, которое будет заменено JS -->
        <tr class="loading-message">
            <td colspan="6">Loading employees...</td>
        </tr>
        </tbody>
    </table>
</div>

<script>
    const responseMessageDiv = document.getElementById('responseMessage'); // Получаем div для сообщений

    // Функция для отображения сообщений
    function showMessage(message, type = 'success') {
        responseMessageDiv.textContent = message;
        responseMessageDiv.className = `message ${type}`; // Устанавливаем классы 'message' и 'success' или 'error'
        responseMessageDiv.classList.remove('hidden'); // Делаем видимым
        // Можно добавить таймер для скрытия сообщения
        setTimeout(() => {
            responseMessageDiv.classList.add('hidden');
        }, 5000); // Скрыть через 5 секунд
    }

    // Функция для загрузки списка сотрудников
    async function loadEmployees() {
        const tableBody = document.querySelector('tbody');
        // Очищаем содержимое таблицы перед загрузкой новых данных
        tableBody.innerHTML = '<tr class="loading-message"><td colspan="6">Loading employees...</td></tr>'; // Отображаем заглушку

        try {
            const response = await axios.get('/v1/employees'); // Получаем список сотрудников
            const employees = response.data;

            tableBody.innerHTML = ''; // Очищаем содержимое таблицы (убираем заглушку)

            // Если сотрудников нет
            if (!employees || employees.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="6" style="text-align: center;">No employees found.</td></tr>';
                return;
            }

            // Отрисовываем каждого сотрудника
            employees.forEach(employee => {
                const row = document.createElement('tr');
                // Добавляем ID к строке, чтобы было легче находить ее для удаления
                row.id = `employee-row-${employee.id}`;

                row.innerHTML = `
                    <td>${employee.id}</td>
                    <td>${employee.name}</td>
                    <td>${employee.age}</td>
                    <td>${employee.address}</td>
                    <td>${employee.position}</td>
                    <td>
                        <a href="/employees/edit-form/${employee.id}" class="action-button secondary">Edit</a>
                        <button onclick="deleteEmployee(${employee.id})" class="action-button delete">Delete</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });

        } catch (error) {
            console.error('Error loading employees:', error);
            let errorMessage = 'Failed to load employees.';
            if (error.response) {
                errorMessage = error.response.data?.message || `Server error ${error.response.status}`;
            } else if (error.request) {
                errorMessage = 'No response from server.';
            }
            showMessage(`Error: ${errorMessage}`, 'error'); // Показываем сообщение об ошибке
            tableBody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: red;">Error loading data.</td></tr>';
        }
    }

    // Функция для удаления сотрудника
    async function deleteEmployee(id) {
        if (!confirm('Are you sure you want to delete this employee?')) {
            return; // Отмена удаления
        }

        try {
            const response = await axios.delete(`/v1/employees/${id}`); // Убедись, что endpoint верный

            if (response.status === 204) { // 204 No Content - успешное удаление
                // Успешно удалили, теперь обновляем список
                showMessage('Employee deleted successfully!', 'success'); // Показываем сообщение об успехе
                loadEmployees(); // Перерисовываем таблицу, чтобы показать изменения

            } else {
                // Если сервер вернул статус, но не 204
                const errorText = response.data?.message || `Failed to delete employee: ${response.status}`;
                showMessage(errorText, 'error');
            }
        } catch (error) {
            console.error('Error deleting employee:', error);
            let errorMessage = 'An error occurred while deleting the employee.';
            if (error.response) {
                errorMessage = error.response.data?.message || `Server error ${error.response.status}`;
            } else if (error.request) {
                errorMessage = 'No response from server.';
            }
            showMessage(`Error: ${errorMessage}`, 'error'); // Показываем сообщение об ошибке
        }
    }

    // При загрузке страницы сразу же загружаем список сотрудников
    document.addEventListener('DOMContentLoaded', loadEmployees);

</script>
</html>